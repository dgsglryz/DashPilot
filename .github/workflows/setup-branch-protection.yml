name: Setup Branch Protection

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to protect (default: main)'
        required: false
        default: 'main'
        type: string
  push:
    branches:
      - main
    paths:
      - '.github/workflows/setup-branch-protection.yml'

permissions:
  contents: write
  pull-requests: write
  statuses: read

jobs:
  protect-main-branch:
    name: Protect Main Branch
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Branch Protection for Main
        uses: actions/github-script@v7
        with:
          script: |
            const branch = '${{ github.event.inputs.branch || "main" }}';
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            
            console.log(`Setting up branch protection for: ${branch}`);
            
            try {
              // Get current branch protection status
              let currentProtection;
              try {
                currentProtection = await github.rest.repos.getBranchProtection({
                  owner: owner,
                  repo: repo,
                  branch: branch
                });
                console.log(`Branch ${branch} already has protection rules. Updating...`);
              } catch (error) {
                if (error.status === 404) {
                  console.log(`Branch ${branch} has no protection rules. Creating...`);
                } else {
                  throw error;
                }
              }
              
              // Get required status checks from CI workflow
              // We need to wait for the workflow to run at least once to get the check name
              // For now, we'll use the job name from ci.yml
              const requiredStatusChecks = [
                'build-test',  // Main CI job
                'sonarcloud'   // SonarCloud scan (optional, will fail gracefully if not configured)
              ];
              
              // Setup branch protection rules
              const protectionSettings = {
                owner: owner,
                repo: repo,
                branch: branch,
                required_status_checks: {
                  strict: true,  // Require branches to be up to date
                  contexts: requiredStatusChecks.filter(check => {
                    // Only include checks that exist
                    // In practice, you might want to verify these exist first
                    return true;
                  })
                },
                enforce_admins: true,  // Apply rules to admins too
                required_pull_request_reviews: {
                  required_approving_review_count: 0,  // Set to 1 if you want required reviews
                  dismiss_stale_reviews: true,
                  require_code_owner_reviews: false,
                  require_last_push_approval: false
                },
                restrictions: null,  // Allow all users (or set specific users/teams)
                allow_force_pushes: false,
                allow_deletions: false,
                block_creations: false,
                required_linear_history: false,
                allow_squash_merge: true,
                allow_merge_commit: true,
                allow_rebase_merge: true,
                allow_auto_merge: false,
                require_conversation_resolution: false,
                require_signed_commits: false,
                lock_branch: false,
                allow_fork_syncing: false
              };
              
              await github.rest.repos.updateBranchProtection(protectionSettings);
              
              console.log(`‚úÖ Successfully protected branch: ${branch}`);
              console.log(`   - Required status checks: ${requiredStatusChecks.join(', ')}`);
              console.log(`   - Force pushes: disabled`);
              console.log(`   - Deletions: disabled`);
              console.log(`   - Admin bypass: disabled`);
              
            } catch (error) {
              console.error('‚ùå Error setting up branch protection:');
              console.error(error.message);
              
              // If it's a permissions error, provide helpful message
              if (error.status === 403) {
                console.error('\n‚ö†Ô∏è  Permission denied. Make sure:');
                console.error('   1. GITHUB_TOKEN has write permissions');
                console.error('   2. You have admin access to the repository');
                console.error('   3. Repository allows GitHub Actions to modify branch protection');
              } else if (error.status === 404) {
                console.error(`\n‚ö†Ô∏è  Branch "${branch}" not found. Make sure the branch exists.`);
              }
              
              throw error;
            }

      - name: Verify Protection Status
        uses: actions/github-script@v7
        with:
          script: |
            const branch = '${{ github.event.inputs.branch || "main" }}';
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            
            try {
              const protection = await github.rest.repos.getBranchProtection({
                owner: owner,
                repo: repo,
                branch: branch
              });
              
              console.log('\nüìã Current Protection Settings:');
              console.log(`   Branch: ${branch}`);
              console.log(`   Protected: ‚úÖ`);
              console.log(`   Required Status Checks: ${protection.data.required_status_checks?.contexts?.join(', ') || 'None'}`);
              console.log(`   Force Pushes: ${protection.data.allow_force_pushes ? '‚úÖ Allowed' : '‚ùå Blocked'}`);
              console.log(`   Deletions: ${protection.data.allow_deletions ? '‚úÖ Allowed' : '‚ùå Blocked'}`);
              console.log(`   Admin Bypass: ${protection.data.enforce_admins ? '‚ùå Disabled' : '‚úÖ Enabled'}`);
              
            } catch (error) {
              console.warn('Could not verify protection status:', error.message);
            }

